name: AI Change Watcher

on:
  schedule:
    - cron: "0 0 * * *"   # 毎日 0:00 UTC（日本時間 9:00）
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ai-change-watcher
  cancel-in-progress: true

jobs:
  run-watcher:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python3 -m pip install -U pip
          pip install -r requirements.txt

      - name: Self-test rules
        run: python3 run_multi.py --selftest --verbose

      - name: Run watcher
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SITE_URL: https://h-sim.github.io/ai-change-watcher/
        run: |
          set -e
          python3 run_multi.py --log-diff-stats | tee run_multi.log
          python3 generate_rss.py
          python3 generate_changes_html.py

          python3 - <<'PY'
          import os, re
          from pathlib import Path

          log_path = Path('run_multi.log')
          lines = log_path.read_text(encoding='utf-8', errors='replace').splitlines() if log_path.exists() else []

          summary_lines = [ln for ln in lines if ln.startswith('[SUMMARY]')]
          target_lines = [ln for ln in lines if re.match(r'^\[(Breaking|High|Medium|Low)\]\s+.+?:\s+.+$', ln)]
          suppress_lines = [ln for ln in lines if ln.startswith('[SUPPRESS]')]

          site_url = (os.getenv('SITE_URL', '') or '').rstrip('/')
          md = []
          md.append('## AI Change Watcher')
          md.append('')
          if site_url:
              md.append(f'- Feeds: {site_url}/feed.xml (Important), {site_url}/feed_all.xml (All)')
              md.append(f'- Browse: {site_url}/changes.html (List)')
          if summary_lines:
              md.extend([f'- {ln}' for ln in summary_lines])
          else:
              md.append('- [SUMMARY] (not found)')
          md.append('')
          md.append('### Targets')
          md.append('')
          if target_lines:
              md.append('|Impact|Target|Result|')
              md.append('|---|---|---|')
              for ln in target_lines:
                  m = re.match(r'^\[(?P<impact>[^\]]+)\]\s+(?P<name>.*?)\s*:\s*(?P<rest>.*)$', ln)
                  if m:
                      md.append(f"|{m.group('impact')}|{m.group('name')}|{m.group('rest')}|")
          else:
              md.append('_No per-target lines found in run_multi.log._')

          md.append('')
          md.append('### Suppressed')
          md.append('')
          if suppress_lines:
              md.append('|Target|Type|Stats|')
              md.append('|---|---|---|')
              for ln in suppress_lines:
                  m2 = re.match(r'^\[SUPPRESS\]\s+(?P<name>.*?)\s*:\s*(?P<rest>.*)$', ln)
                  if not m2:
                      continue
                  rest = m2.group('rest')
                  typ = rest.split()[0] if rest else ''
                  stats = rest[len(typ):].strip() if rest else ''
                  md.append(f"|{m2.group('name')}|{typ}|{stats}|")
          else:
              md.append('_No suppressed changes._')

          summary_path = os.environ.get('GITHUB_STEP_SUMMARY')
          if summary_path:
              with open(summary_path, 'a', encoding='utf-8') as f:
                  f.write('\n'.join(md) + '\n')
          else:
              print('\n'.join(md))
          PY

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Update RSS feed"
          git push
