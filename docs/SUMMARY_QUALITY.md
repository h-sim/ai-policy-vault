# AI Policy Vault — Summary Quality Spec（MVP）

> **原則（変更禁止）**
> - **断定禁止**: 「安全」「問題なし」「変化なし」「準拠」は使わない。
> - **Detection のみ**: 変化の有無を検出・記録するのみ。内容の解釈・リスク評価（Judgment）はしない。
> - **品質低ければ空文字で継続**: 要約が基準を満たさない場合は `summary_ja=""` のまま処理を継続する（処理を止めない）。

---

## 1. 目的と非目的

### 目的

- 運用者が「これを読めば何を確認すべきかわかる」3行に仕上げる
- 要約の品質・書式にブレが生じないよう、入力/出力/検品の基準を事前に定める

### 非目的

- 法務判断・リスク評価の代行（Detection のみ。Judgment は人間が実施する）
- 変化内容の正確性・完全性の保証（一次情報は公式原文で目視確認する）
- 「問題があるか/安全か」の判定

---

## 2. 入力仕様（LLMに渡す材料）

### 現状の入力元

- `diff snippet`: 前回スナップショットと今回取得内容の差分テキスト（`run_multi.py` の summarize 呼び出し時点で渡す）

### 将来実装：要点抽出ルール（現状は未実装・仕様のみ定義）

ノイズの多い HTML 系ターゲットで diff snippet が長大になる場合に備え、以下のルールで高シグナル行を抽出した後に LLM に渡す。ルールベースで実装可能。

| ルール | 内容 |
|---|---|
| 対象行 | `+` または `-` 始まりの差分行のみ |
| 行数上限 | 最大 20 行（高シグナルキーワードを含む行を優先して残す） |
| 1行文字数上限 | 200 文字（超過分は切り詰め） |
| 優先キーワード | `deprecat` / `sunset` / `removed` / `breaking` / `pricing` / `security` / `policy` / `retention` / `training` / `fine-tuning` / `rate limit` |
| それ以外の行 | キーワードなしの変更行は行数が余る場合のみ追加 |

> キーワードリストは `targets.py` の `classify_impact()` で使用するシグナルリストと整合させる。

---

## 3. 出力仕様（必ず3行固定）

### フォーマット（厳守）

```
1行目: [変更] 何が変わったか（対象 + 変更種別）
2行目: [影響] 契約/価格/廃止/互換性/運用のどれかの観点で考えられる影響（断定禁止）
3行目: [確認] 一次情報の確認先（URL / セクション名 / 見るべきキーワード）
```

- 各行は120文字以内を目標とする（検品ルールの上限は120文字）
- 「安全」「問題なし」「変化なし」「準拠」は使用禁止
- diff に存在しない固有名詞・数字を追加することは禁止

### 書式例（架空例）

**Breaking 系（APIバージョン廃止）:**

```
[変更] OpenAI Chat API v1 エンドポイントが deprecated に移行。移行期限の記述を確認。
[影響] 既存インテグレーションが動作しなくなる可能性あり（移行対応が必要な場合がある）。
[確認] https://platform.openai.com/docs/deprecations — "v1/chat/completions" セクション参照。
```

**価格改定系（トークン単価変更）:**

```
[変更] GPT-4 系モデルの入力トークン単価に関する記述が更新された。
[影響] API利用コストに影響する可能性あり（社内利用量の試算を再確認することを推奨）。
[確認] https://openai.com/pricing — "GPT-4" 行の "Input" 列を目視確認すること。
```

---

## 4. 禁止事項（安全・品質）

| 分類 | 禁止内容 |
|---|---|
| 断定禁止 | 「安全」「問題なし」「準拠している」「影響はない」等の断定表現を使わない |
| 推測禁止 | diff に存在しない固有名詞・数字・仕様を LLM が作り出すことを禁止 |
| 根拠なき比較禁止 | 「以前は〜だった」等、diff に記載のない過去の状態を記述しない |
| PII 禁止 | 個人名・メールアドレス・API キー等の個人情報・秘密情報を出力しない |
| 3行超え禁止 | 追記・補足・注意書きを加えて3行を超えてはいけない |

---

## 5. 検品（低品質なら捨てる = 空文字）

### 捨てる条件（将来実装として仕様を定義）

以下のいずれかに該当する場合は、要約を **破棄**（`summary_ja = ""`）して処理を継続する。

| # | 条件 | 例 |
|---|---|---|
| 1 | 3行でない（2行以下 or 4行以上） | — |
| 2 | 断定語を含む | 「安全」「問題なし」「変化なし」「準拠」 |
| 3 | 1行が120文字を超える | — |
| 4 | 推測語が過多（3つ以上含む） | 「〜かもしれない」「〜と思われる」「〜の可能性がある」が連続 |
| 5 | diff に存在しない固有名詞・数字を含む | LLM が架空の価格や日付を生成した場合 |

### 捨てた場合の処理

- `summary_ja = ""`（空文字）のまま `state.json` に記録する
- 変化記録（diff / impact / reasons 等）は保全される
- 処理は中断しない（既存の「API 失敗時は空文字で継続」設計と同じ）

### 将来候補のログ仕様（今回は実装しない）

```
[HEALTH] SKIP stage=summarize reason="low_quality"
```

---

## 6. 実装の最小差分（今回はやらない）

> このセクションは **設計メモ**。このドキュメントの作成時点ではコード変更しない。

### 触るファイル候補

| ファイル | 変更内容（案） |
|---|---|
| `run_multi.py` | summarize 関数に検品ロジック（Section 5 の捨てる条件）を追加 |
| `run_multi.py` | 将来：高シグナル行抽出ルール（Section 2）を前処理として追加 |
| selftest | 形式検査テストを追加（Section 7 参照） |

### selftest 追加候補（ネットワーク不要の形式検査）

1. **3行チェック**: `summarize_quality_check("1行\n2行\n3行")` → PASS / `"1行\n2行"` → FAIL
2. **断定語チェック**: `summarize_quality_check("...\n影響はない。\n...")` → FAIL（「影響はない」は断定語）

> **実装は別タスク。** 発動条件は `docs/MVP_CHECKLIST.md` Section 6「要約の品質向上」を参照。
